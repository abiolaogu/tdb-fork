# deploy/docker/docker-compose.yml

version: '3.8'

services:
  lumadb:
    # Use ghcr.io image or build locally
    image: ghcr.io/abiolaogu/lumadb:latest
    build:
      context: ../../
      dockerfile: deploy/docker/Dockerfile
    container_name: lumadb
    ports:
      - "8080:8080" # REST API
      - "9092:9092" # Kafka Protocol
      - "4000:4000" # GraphQL
      - "5432:5432" # PostgreSQL Protocol
    environment:
      - LUMADB_NODE_ID=1
      - LUMADB_DATA_DIR=/data
      - LUMADB_LOG_LEVEL=info
    volumes:
      - lumadb-data:/data
      - lumadb-logs:/var/log/lumadb
      # Mount config if needed, or rely on image default
      # - ./configs:/etc/lumadb:ro
    healthcheck:
      # Distroless might not have curl, adjust if needed or use internal health check
      test: [ "CMD", "/usr/local/bin/lumadb", "health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:size=100M

volumes:
  lumadb-data:
  lumadb-logs:
