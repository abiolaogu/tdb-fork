# .github/workflows/ci.yml

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # Build & Test - Rust
  # ============================================
  rust:
    name: Rust Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          components: clippy, rustfmt
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Format Check
        run: cargo fmt --all -- --check
        working-directory: rust-core
      
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        working-directory: rust-core
      
      - name: Build
        run: cargo build --release --all-features
        working-directory: rust-core
      
      - name: Test
        run: cargo test --release --all-features
        working-directory: rust-core
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-artifacts
          path: rust-core/target/release/liblumadb_core.so

  # ============================================
  # Build & Test - Go
  # ============================================
  go:
    name: Go Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: Cache Go
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
      
      - name: Format Check
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go files need formatting:"
            gofmt -l .
            exit 1
          fi
      
      - name: Lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
      
      - name: Build
        run: go build -v ./...
      
      - name: Test
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out

  # ============================================
  # Integration Tests
  # ============================================
  integration:
    name: Integration Tests
    needs: [rust, go]
    runs-on: ubuntu-latest
    services:
      lumadb:
        image: ghcr.io/abiolaogu/lumadb:latest # Use latest build ideally
        ports:
          - 8080:8080
          - 9092:9092
        options: >-
          --health-cmd "/usr/local/bin/lumadb health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      # Wait for LumaDB effectively handled by service healthcheck, but explicit check is good
      
      - name: Run Integration Tests
        run: go test -v -tags=integration ./tests/integration/...
        env:
          LUMADB_BROKER: localhost:9092
          LUMADB_REST_URL: http://localhost:8080

  # ============================================
  # E2E Tests
  # ============================================
  e2e:
    name: E2E Tests
    needs: [integration]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install pytest pytest-asyncio kafka-python requests
      
      - name: Start LumaDB
        run: |
          docker-compose -f deploy/docker/docker-compose.yml up -d
          sleep 30
      
      - name: Run E2E Tests
        run: pytest tests/e2e/ -v --tb=short
      
      - name: Collect Logs
        if: failure()
        run: docker-compose -f deploy/docker/docker-compose.yml logs

  # ============================================
  # Build Docker Images
  # ============================================
  docker:
    name: Build Docker
    needs: [rust, go]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deploy/docker/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ghcr.io/abiolaogu/lumadb:${{ github.sha }}
            ghcr.io/abiolaogu/lumadb:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ============================================
  # Cross-Platform Builds
  # ============================================
  build-binaries:
    name: Build Binaries
    needs: [rust, go]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: lumadb-linux-amd64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: lumadb-windows-amd64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: lumadb-darwin-amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: lumadb-darwin-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}
      
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: Build Rust
        run: cargo build --release --target ${{ matrix.target }}
        working-directory: rust-core
      
      - name: Build Go
        run: |
          go build -o lumadb${{ matrix.os == 'windows-latest' && '.exe' || '' }} ./cmd/lumadb
        env:
          CGO_ENABLED: 0 # Only convenient if not relying on FFI for cross-build
      
      - name: Package
        shell: bash
        run: |
          mkdir -p dist
          cp lumadb* dist/ 2>/dev/null || true
          # We might skip copying .so/dll if we static link or if CGO disabled. 
          # For full production we need cross-compile CGO which is complex, placeholder here.
          zip -r ${{ matrix.artifact }}.zip dist/
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.zip
